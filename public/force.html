<!DOCTYPE html>
<meta charset="utf-8">
<head>
  <script src="/javascripts/components/d3/d3.min.js"></script>
  <script src="/javascripts/components/jquery/dist/jquery.min.js"></script>
  <script src="/javascripts/components/underscore/underscore-min.js"></script>
  <script src="/javascripts/components/lodash/lodash.min.js"></script>
  <script src="/javascripts/components/underscore.nest/underscore.nest.min.js"></script>

  <style>
    .node {
      stroke: #fff;
      stroke-width: 2.5px;
    }

    .link {
      stroke: #999;
      stroke-opacity: .3;
    }

  </style>
</head>

<body>
<div id="chart" style="margin:10px 10px">
<a href="kanban.html" title="back to kanban board"><img src="/images/bpty_logo.png" style="width:10%;height:10%"/></a>
<br><br>

<b>FORCEMAP experiments - current backlog</b><br>
<script>

  var data,root;
  var width = 1600,
  		height = 1000;
  var color = d3.scale.category20();
  var force = d3.layout.force()
      .charge(-100)
      .linkDistance(300)
      .size([width, height]);
  var svg = d3.select("body").append("svg")
      .attr("width", width)
      .attr("height", height);

  var nodes,links;

  // /api/space/rest/organization/employee/
  // http://my.bwinparty.com/api/people/images/e2988


  //var _dataUri = "/api/space/rest/initiatives";
  //var _dataUri = "/api/space/rest/target2employee";
  var _dataUri = "/api/space/rest/employeebytargets";
  var _orgUri = "/api/space/rest/organization";
  var _targetUri = "/api/space/rest/targets";

  d3.json(_orgUri,function(organization){
  	d3.json(_dataUri,function(data){
      console.log("*************data: "+JSON.stringify(data));
      console.log("*************organization: "+organization.length);

  	  root = _.nest(data,["target,employeeID"]);
      console.log("root: "+JSON.stringify(root));

      //root = data;

      nodes = flatten(root),
      links = d3.layout.tree().links(nodes);

      console.log("nodes: "+JSON.stringify(nodes));

      force
          .nodes(nodes)
          .links(links)
          .start();

      var link = svg.selectAll(".link")
          .data(links)
        .enter().append("line")
          .attr("class", "link")
          .style("stroke-width", function(d) { return Math.sqrt(d.value); });

      var i=0;
      var node = svg.selectAll("node")
        .data(nodes)
        .enter()
        .append("g")

        .each(function(d){
          // items
          if (!d.children){
            var _r = 5;//d.size*1.2;
          	d3.select(this).append("circle")
              .attr("class", "node")
              .attr("r", _r)//d.Swag/200})
              .attr("transform","translate("+_r+","+_r+")")
              .style("fill", function(d) { return color(d.lane); })
              .style("opacity",1);

      		   d3.select(this).append("use").attr("xlink:href","#"+d.Type).attr("transform","scale("+d.size/12+")");


/*
             d3.select(this).append("text")
            	//.text(function(d){return d.name})
              .text(function(d){
                var _employee = _.findWhere(organization,{"Employee Number":d.employeeID});
                return _employee["First Name"]+" "+_employee["Last Name"]
                })
            	.style("font-size","10px")
            	.style("font-weight","bold")
            	.style("font-family","arial");
            	//.attr("dy",(2*_r)+5).style("text-anchor","middle");
*/

            d3.select(this).append("text")
             .text(function(d){return d.target})
             .style("font-size","10px")
             .style("font-weight","bold")
             .style("font-family","arial");

/*
            d3.select(this).append("svg:image")
            	.attr("xlink:href", function(d){return "http://my.bwinparty.com/api/people/images/"+d.employeeID;})
                      .attr("x", "-20")
                      .attr("y", "-140")
                      .attr("width", "100")
                      .attr("height", "125");
*/

    	    }
    	    else{
    	   /*d3.select(this).append("circle")
          .attr("class", "node")
          .attr("r", function(d){if (!d.children) return 20; return 10;})//d.Swag/200})
          .style("fill", function(d) { return color(d.lane); })
         */

         console.log("***** has children: "+d.name+" i: "+i+" x,y "+d.x+" , "+d.y);

       	 var _logo=d.name;
       	 if (d.name=="bwin") _logo = "bwin_black";
       	 console.log(".....logo: "+_logo);

       	 d3.select(this).append("use").attr("xlink:href","#"+_logo).attr("transform","scale(1.5)").style("opacity",1);//+_logo)

         var _size = 10;
         if (d.size) _size = d.size;

         d3.select(this).append("circle")
          .attr("class", "node")
          .attr("r", function(d){return _size/2;})
          //.attr("cx",d.x)
          //.attr("cy",d.y)//d.Swag/200})
          .style("fill", "grey");//function(d) { return color(d.lane); })

        	d3.select(this).append("text").text(function(d){return d.name})
        	.style("font-size","8px")
        	.style("font-family","arial")
        	.attr("dy",14).style("text-anchor","middle");

        }
          d3.select(this).call(force.drag);

      d3.select(this).append("title")
          .text(function(d) { return d.name; });
    	i++;


      force.on("tick", function() {
        link.attr("x1", function(d) { return d.source.x; })
            .attr("y1", function(d) { return d.source.y; })
            .attr("x2", function(d) { return d.target.x; })
            .attr("y2", function(d) { return d.target.y; });

    	var _size;
    	if (d.size) _size=d.size/10;
    	else _size = 1;

        node//.attr("x", function(d) { return d.x; })
            //.attr("y", function(d) { return d.y; })
            .attr("transform",function(d){return "translate ("+d.x+","+d.y+") scale("+_size+")"});
    });
  });

});

})

// Returns a list of all nodes under the root.
function flatten(root) {
  var nodes = [], i = 0;

  function recurse(node) {
    if (node.children) node.children.forEach(recurse);
    if (!node.id) node.id = ++i;
    nodes.push(node);
  }
  recurse(root);
  return nodes;
}
</script>

</div>
</body>
</html>
